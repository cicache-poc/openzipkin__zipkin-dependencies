# PoC of the potential cache leakage/poisoning vulnerability of the openzipkin/zipkin-dependencies repository.

The following are the step-by-step reproduction instructions for the potential cache leakage/poisoning vulnerability of the [openzipkin/zipkin-dependencies](https://github.com/openzipkin/zipkin-dependencies) repository.

**Note** that since GitHub Actions automatically purges CI task logs older than 90 days [1], the logs for the CI task we previously used for validation have been purged. Therefore, we reran the PoC test for analysis.

## Attack Notes

- As the victim repository utilizes the git tag trigger, it cannot be attacked by an unethical non-collaborator pull request initiator. However, if the repository does **not** set appropriate tag protection rules, it may be attacked by **unethical repository collaborators**, as the defined threat model. 
- The cache file remains intact when GitHub deletes a git tag. Consequently, if the tag is later recreated, the repository will reuse the pre-existing (poisoned) cache.


## Detailed Steps. 

Below are the steps for reproducing a cache leakage attack against the openzipkin/zipkin-dependencies repository.

### Cache leakage attack.
An attacker (i.e., `lowleveluser-cicache`) wants to read the CI cache file corresponding to the git tag `docker-3.0.0`. 

1. The repository owner publishes the `docker-3.0.0` tag, triggers the CI task, and generates a cache containing secrets (line 82 in the build log ([link](https://github.com/cicache-poc/openzipkin__zipkin-dependencies/actions/runs/6515342221/job/17697632929)) of the “Post Cache Docker” step of the "docker_push" job).

2. The attacker deletes the tag of `docker-3.0.0`, the specific command is `git tag -d docker-3.0.0 && git push origin --delete docker-3.0.0`. 

3. The attacker republishes the `docker-3.0.0` tag (the specific command is `git tag docker-3.0.0 && git push origin docker-3.0.0`), and a CI task will be triggered at this time, which can successfully access `docker-3.0.0` corresponds to the cache file. You can view the log of the successful cache restoration (line 89 in the build log ([link](https://github.com/cicache-poc/openzipkin__zipkin-dependencies/actions/runs/6515430077/job/17697829212)) of the "Cache Docker" step of the "docker_push" job).

### Cache poisoning attack.
An attacker (i.e., `lowleveluser-cicache`) wants to poison the cache file so that when the victim repository owner builds a specific version (e.g., `docker-4.0.0`), the poisoned cache is used. 

1. The attacker releases the `docker-4.0.0` tag to trigger a CI task that generates a cache containing malicious code (line 82 in the build log ([link](https://github.com/cicache-poc/openzipkin__zipkin-dependencies/actions/runs/6515610388/job/17698228971)) of the "Post Cache Docker" step of the "docker_push" job). 

2. Then, the attacker deletes the `docker-4.0.0` tag. Note that GitHub will not delete the cache corresponding to the `docker-4.0.0` tag at this time. 

3. When the owner releases the `docker-4.0.0` tag and triggers the execution of the CI task, the cache generated by the attacker is reused. The attack is successful. You can view the log of the successful cache recovery from the CI task log (line 89 in the build log ([link](https://github.com/cicache-poc/openzipkin__zipkin-dependencies/actions/runs/6515628062/job/17698269229)) of the "Cache Docker" step of the "docker_push" job).


## References:
1. Artifact and log retention policy, GitHub Doc. https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration#artifact-and-log-retention-policy


